function dxdt = aircraft_dynamics_linear(x, u, mode) 
% x: 13x1 full state (SoC at index 3)
% u: [u1; u2; u3; u4; xs; xt; ...]
% mode: 1=takeoff, 2=cruise, 3=landing  

    % --- allow Simulink to call without params during compile/validation ---
    if nargin < 3 || isempty(mode)
        mode = 1;  % default to TAKEOFF so validation can run
    end
    mode = max(1, min(3, double(mode)));  % clamp & ensure double

    % --- unpack the inputs you actually use ---
    u1 = u(1);  u2 = u(2);  u3 = u(3);  u4 = u(4);
    xs = u(5);  xt = u(6);
    umv = [u1; u2; u3; u4];              

    % --- reduced state (remove SoC at index 3) -> 12x1 ---
    xr = [x(1:2); x(4:end)];

    % --- persistent plant data: PRE-ALLOCATE STRUCT ARRAY FIRST ---
    persistent PLANTS initd
    if isempty(initd)
        % Preallocate 1x3 struct array with fixed field sizes for codegen:
        PLANTS = repmat(struct( ...
            'A',  zeros(12,12), ...
            'B',  zeros(12,4),  ...
            'E',  zeros(12,2),  ...  
            'P0', zeros(12,1)   ...
        ), 1, 3);

        % ====== TAKEOFF (mode=1) ======
        PLANTS(1).A  = [ ...
            -19227/245000,  19227/245000,       0,            0,            0,            0,            0,            0,            0,            0,       0,      0; 
              663/35000,   -13519/406000,       0,            0,            0,            0,   4163/290000,            0,            0,            0,       0,      0;
                   0,              0,   -19227/175000, 19227/175000,        0,            0,            0,            0,            0,            0,       0,      0;
                   0,     4163/210000,   6409/245000, -13519/294000,        0,            0,            0,            0,            0,            0,       0,      0;
                   0,              0,            0,            0,   -19227/280000, 19227/280000,        0,            0,            0,            0,       0,      0;
                   0,              0,            0,     4163/330000, 6409/385000,  -1229/42000,        0,            0,            0,            0,       0,      0;
                   0,              0,            0,            0,            0,            0,  -4163/200000,          0,            0,   4163/200000,       0,      0;
                   0,              0,            0,            0,            0,            0,            0, -10013/105000, 10013/105000,          0,       0,      0;
                   0,              0,            0,            0,            0,    4163/500000,        0,   30039/1750000, -89219/3500000,       0,       0,      0;
                   0,              0,            0,            0,            0,            0,            0,            0,    4163/130000, -184163/130000, 18/13, 0;
                   0,              0,            0,            0,            0,            0,            0,            0,            0,        6/5, -139/30, 103/30;
                   0,              0,            0,            0,            0,            0,            0,            0,            0,            0, 12875/503, -36172229/1408400];
        PLANTS(1).B  = [ ...
           163/205065000, 0, 0, 0; 0, 0, -3207188/235779831, 0; 0, 0, 0, 0; 0, 0, -898000/512211357, 0; ...
           0, 163/280000000, 0, 0; 0, 0, -1041407/96165300, 0; 0, 0, 0, 0; 0, 0, 0, 0; ...
           0, 0, -292748/24391017, 0; 0, 0, 3387354059/31708322100, 0; 0, 0, 0, 0; 0, 0, 0, -1290326772013/2046113460000];
        PLANTS(1).E  = [ ...
           0, 0; 0, 0; 1/14647500, 0; 0, 0; 0, 0; 0, 0; 0, 0; 163/263655000, 0; 0, 0; 0, 0; 0, 0; 0, 1/70420];
        PLANTS(1).P0 = [ ...
           0; 801797/14159250; 0; 898/123039; 0; 1041407/23100000; 0; 0; 73187/1464750; -3387354059/7616700000; 0; 1290326772013/336808800000];

        % ====== CRUISE (mode=2) ======
        PLANTS(2).A  = [ ...
           -19227/245000, 19227/245000, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0; 663/35000, -30727/812000, 0, 0, 0, 0, 10961/580000, 0, 0, 0, 0, 0; ...
           0, 0, -19227/175000, 19227/175000, 0, 0, 0, 0, 0, 0, 0, 0; 0, 10961/420000, 6409/245000, -30727/588000, 0, 0, 0, 0, 0, 0, 0, 0; ...
           0, 0, 0, 0, -19227/280000, 19227/280000, 0, 0, 0, 0, 0, 0; 0, 0, 0, 10961/660000, 6409/385000, -30727/924000, 0, 0, 0, 0, 0, 0; ...
           0, 0, 0, 0, 0, 0, -10961/400000, 0, 0, 10961/400000, 0, 0; 0, 0, 0, 0, 0, 0, 0, -10013/105000, 10013/105000, 0, 0, 0; ...
           0, 0, 0, 0, 0, 10961/1000000, 0, 30039/1750000, -196883/7000000, 0, 0, 0; 0, 0, 0, 0, 0, 0, 0, 0, 10961/260000, -370961/260000, 18/13, 0; ...
           0, 0, 0, 0, 0, 0, 0, 0, 0, 6/5, -139/30, 103/30; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 12875/503, -18096929/704200];
        PLANTS(2).B  = [ ...
           163/205065000, 0, 0, 0; 0, 0, -4562696/1862394471, 0; 0, 0, 0, 0; 0, 0, -1048000/1348630479, 0; 0, 163/280000000, 0, 0; ...
           0, 0, -6520/843997, 0; 0, 0, 0, 0; 0, 0, 0, 0; 0, 0, -341648/64220499, 0; 0, 0, 5580688/119266641, 0; 0, 0, 0, 0; 0, 0, 0, -1405698391771/4214320110000];
        PLANTS(2).E  = PLANTS(1).E;
        PLANTS(2).P0 = [ ...
           0; 570337/42477750; 0; 524/123039; 0; 163/3850; 0; 0; 21353/732375; -348793/1360125; 0; 1405698391771/589415400000];

        % ====== LANDING (mode=3) ======
        PLANTS(3).A  = [ ...
           -19227/245000, 19227/245000, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0; 663/35000, -67399/2030000, 0, 0, 0, 0, 827/58000, 0, 0, 0, 0, 0; ...
           0, 0, -19227/175000, 19227/175000, 0, 0, 0, 0, 0, 0, 0, 0; 0, 827/42000, 6409/245000, -67399/1470000, 0, 0, 0, 0, 0, 0, 0, 0; ...
           0, 0, 0, 0, -19227/280000, 19227/280000, 0, 0, 0, 0, 0, 0; 0, 0, 0, 827/66000, 6409/385000, -67399/2310000, 0, 0, 0, 0, 0, 0; ...
           0, 0, 0, 0, 0, 0, -827/40000, 0, 0, 827/40000, 0, 0; 0, 0, 0, 0, 0, 0, 0, -10013/105000, 10013/105000, 0, 0, 0; ...
           0, 0, 0, 0, 0, 827/100000, 0, 30039/1750000, -89023/3500000, 0, 0, 0; 0, 0, 0, 0, 0, 0, 0, 0, 827/26000, -36827/26000, 18/13, 0; ...
           0, 0, 0, 0, 0, 0, 0, 0, 0, 6/5, -139/30, 103/30; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 12875/503, -113193957/4401250];
        PLANTS(3).B  = [ ...
           163/205065000, 0, 0, 0; 0, 0, -2281348/702581985, 0; 0, 0, 0, 0; 0, 0, -6274/11305917, 0; 0, 163/280000000, 0, 0; ...
           0, 0, -5830021/955185000, 0; 0, 0, 0, 0; 0, 0, 0, 0; 0, 0, -511331/134594250, 0; 0, 0, 12045384577/314950545000, 0; 0, 0, 0, 0; 0, 0, 0, -8752431102689/31504253130000];
        PLANTS(3).E  = PLANTS(1).E;
        PLANTS(3).P0 = [ ...
           0; 570337/42477750; 0; 3137/1367100; 0; 5830021/231000000; 0; 0; 511331/32550000; -12045384577/76167000000; 0; 8752431102689/3683846250000];

        initd = true;
    end

    % --- select active matrices ---
    A  = PLANTS(mode).A;
    B  = PLANTS(mode).B;
    E  = PLANTS(mode).E;
    P0 = PLANTS(mode).P0;

    % --- disturbances & affine model on reduced state ---
    P_s    = u4 * 1006 * xs;
    xdot12 = A * xr + B * umv + E * [xt; P_s] + P0;   % 12x1

    % --- SoC dynamics ---
    SoCdot = -1000/(837*300*630*3600) * u1;

    % --- assemble full derivative (13x1) ---
    dxdt        = zeros(13,1);
    dxdt(1:2)   = xdot12(1:2);
    dxdt(3)     = SoCdot;
    dxdt(4:13)  = xdot12(3:12);
end